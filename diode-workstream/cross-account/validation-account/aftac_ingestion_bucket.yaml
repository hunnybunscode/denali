Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General
        Parameters:
          - ResourceSuffix

      - Label:
          default: Tags
        Parameters:
          - IngestBucketMappingId
          - IngestBucketDestionationBucket
          - IngestBucketGovPoc
          - IngestBucketDataOwner
          - IngestBucketKeyOwner

      - Label:
          default: Bucket Policy [OPTIONAL]
        Parameters:
          - AllowedRoleArn

      - Label:
          default: SFTP [OPTIONAL]
        Parameters:
          - SftpUserName
          - SshPublicKeys

      - Label:
          default: Bucket LifeCycle Configuration
        Parameters:
          - TranstionToGlacierIR
          - TransitionToDeepArchive
          - BucketExpirationInDays

    ParameterLabels:
      ResourceSuffix:
        default: Resource Suffix
      IngestBucketMappingId:
        default: Mapping ID [Conditional]
      IngestBucketDestionationBucket:
        default: Destination Bucket Name [Conditional]
      IngestBucketGovPoc:
        default: GOV POC
      IngestBucketDataOwner:
        default: Data Owner
      IngestBucketKeyOwner:
        default: Key Owner
      AllowedRoleArn:
        default: Allowed Role ARN
      SftpUserName:
        default: SFTP User Name
      SshPublicKeys:
        default: SSH Public Keys
      TranstionToGlacierIR:
        default: Object Transition To Glacier_IR
      TransitionToDeepArchive:
        default: Object Transition To Deep Archive
      BucketExpirationInDays:
        default: Object Expiration In Days

Parameters:
  ResourceSuffix:
    Type: String
    Description: >-
      (Required) Suffix added to the named AWS resources. It must start with a lowercase letter and contain
      only lowercase letters, numbers, and hyphens; its length cannot exceed 20.
    AllowedPattern: ^[a-z0-9-]{1,20}$
    ConstraintDescription: Must start with a lowercase letter and contain only lowercase letters, numbers, and hyphens; its length cannot exceed 20.

  IngestBucketMappingId:
    Type: String
    Description: (Conditional) Value for tag key MappingId. Do not specify a value here if you specify a value in Destination Bucket Name.
    Default: 12346789-abcd-1234-abcd-123456789012
    AllowedPattern: ^$|^[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$
    ConstraintDescription: Must be a valid Mapping ID

  IngestBucketDestionationBucket:
    Type: String
    Description: (Conditional) Value for tag key DestinationBucket. Do not specify a value here if you specify a value in Mapping ID.
    AllowedPattern: ^$|^(?!\s*arn:)\S+$
    ConstraintDescription: Must be a valid bucket name

  IngestBucketGovPoc:
    Type: String
    Description: (Required) Value for tag key GovPOC
    Default: Monica

  IngestBucketDataOwner:
    Type: String
    Description: (Required) Value for tag key DataOwner
    Default: Phoebe

  IngestBucketKeyOwner:
    Type: String
    Description: (Required) Value for tag key KeyOwner
    Default: Chandler

  AllowedRoleArn:
    Type: String
    Description: (Optional) ARN of the role that is allowed to write to the ingestion bucket
    AllowedPattern: ^$|^arn:(aws|aws-us-gov):iam::\d{12}:role/\S+
    ConstraintDescription: Must start with 'arn:' and be composed of lowercase letters, numbers, and hyphens; it cannot exceed 1024 characters.

  SftpUserName:
    Type: String
    Description: Username for SFTP user who is allowed to write to the ingestion bucket via SFTP
    AllowedPattern: ^$|^(?![-.@].*)[a-zA-Z0-9-_.@]{3,100}$
    ConstraintDescription: >-
      Username must be a minimum of 3 and a maximum of 100 characters long.
      The following are valid characters: a-z, A-Z, 0-9, underscore '_', hyphen '-', period '.', and at sign '@'.
      The user name can't start with a hyphen, period, or at sign.

  SshPublicKeys:
    Type: CommaDelimitedList
    Description: >-
      Public key portion of the SSH keys stored for the SFTP user. If adding more than one, separate them with a comma.
      If you want to delete the key(s), clear out the contents from this field.

  TranstionToGlacierIR:
    Type: Number
    Description: Enter the number of days after which to transition to Glacier Instant Retrieval (IR) storage class.
    Default: 60

  TransitionToDeepArchive:
    Type: Number
    Description: Enter the number of days after which to transition to Deep Archive storage class. Must be at least 90 days after Glacier IR transition.
    Default: 150

  BucketExpirationInDays:
    Type: Number
    Description: Enter the number of days you want to keep objects in the LONG TERM STORAGE Bucket.
    Default: 365

Rules:
  MappingIdOnly:
    RuleCondition: !Not [!Equals [!Ref IngestBucketMappingId, ""]]
    Assertions:
      - Assert: !Equals [!Ref IngestBucketDestionationBucket, ""]
        AssertDescription: You cannot specify a value in both Mapping ID and Destination Bucket Name
  DestinationBucketOnly:
    RuleCondition: !Not [!Equals [!Ref IngestBucketDestionationBucket, ""]]
    Assertions:
      - Assert: !Equals [!Ref IngestBucketMappingId, ""]
        AssertDescription: You cannot specify a value in both Mapping ID and Destination Bucket Name

Conditions:
  CreateSftpUser: !Not [!Equals [!Ref SftpUserName, ""]]
  SshPublicKeyProvided: !Not [!Equals [!Join ["", !Ref SshPublicKeys], ""]]
  UseMappingId: !Not [!Equals [!Ref IngestBucketMappingId, ""]]
  UseDestinationBucket: !Not [!Equals [!Ref IngestBucketDestionationBucket, ""]]
  UseAllowedRoleArn: !Not [!Equals [!Ref AllowedRoleArn, ""]]

Resources:
  IngestBucket:
    Type: AWS::S3::Bucket
    Properties:
      LoggingConfiguration:
        DestinationBucketName:
          Fn::ImportValue: !Sub access-logs-bucket-${ResourceSuffix}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled
      NotificationConfiguration:
        LambdaConfigurations:
          - Event: s3:ObjectCreated:*
            Function:
              Fn::ImportValue: !Sub aftac-pipeline-object-tagger-${ResourceSuffix}
      LifecycleConfiguration:
        Rules:
          - Id: LifeCycleRule-1
            Status: Enabled
            Transitions:
              - TransitionInDays: !Ref TranstionToGlacierIR
                StorageClass: GLACIER_IR
              - TransitionInDays: !Ref TransitionToDeepArchive
                StorageClass: DEEP_ARCHIVE
            ExpirationInDays: !Ref BucketExpirationInDays
            NoncurrentVersionExpiration:
              NoncurrentDays: 1
      Tags:
        - !If
          - UseMappingId
          - Key: MappingId
            Value: !Ref IngestBucketMappingId
          - !Ref AWS::NoValue
        - !If
          - UseDestinationBucket
          - Key: IngestBucketDestionationBucket
            Value: !Ref IngestBucketDestionationBucket
          - !Ref AWS::NoValue
        - Key: GovPOC
          Value: !Ref IngestBucketGovPoc
        - Key: DataOwner
          Value: !Ref IngestBucketDataOwner
        - Key: KeyOwner
          Value: !Ref IngestBucketKeyOwner

  IngestBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref IngestBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Deny
            Principal:
              AWS: "*"
            Action: s3:*
            Resource:
              - !Sub ${IngestBucket.Arn}
              - !Sub ${IngestBucket.Arn}/*
            Condition:
              Bool:
                aws:SecureTransport: false
          - !If
            - UseAllowedRoleArn
            - Effect: Allow
              Principal:
                AWS: !Ref AllowedRoleArn
              Action: s3:PutObject
              Resource: !Sub ${IngestBucket.Arn}/*
            - !Ref AWS::NoValue

  TransferUser:
    Type: AWS::Transfer::User
    Condition: CreateSftpUser
    Properties:
      ServerId:
        Fn::ImportValue: !Sub SFTPServerId-${ResourceSuffix}
      Role:
        Fn::ImportValue: !Sub TransferUserRoleArn-${ResourceSuffix}
      UserName: !Ref SftpUserName
      HomeDirectoryType: LOGICAL
      HomeDirectoryMappings:
        - Entry: / # chroot
          Target: !Sub /${IngestBucket}/${SftpUserName} # Limit visibility to this directory (and below) only
          Type: DIRECTORY
      SshPublicKeys: !If
        - SshPublicKeyProvided
        - !Ref SshPublicKeys
        - []
