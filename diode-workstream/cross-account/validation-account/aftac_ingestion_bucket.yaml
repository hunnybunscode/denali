Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General
        Parameters:
          - IamPrefix
          - ResourceSuffix

      - Label:
          default: Tags
        Parameters:
          - IngestBucketMappingId
          - IngestBucketDestinationBucket

          - IngestBucketDataOwner
          - IngestBucketDataSteward
          - IngestBucketGovPoc
          - IngestBucketKeyOwner

      - Label:
          default: (OPTIONAL) Bucket Policy Configuration
        Parameters:
          - AllowedExternalRoleArn

      - Label:
          default: (OPTIONAL) SFTP
        Parameters:
          - SftpUserName
          - SshPublicKeys

      - Label:
          default: Bucket LifeCycle Configuration
        Parameters:
          - ObjectExpirationInDays

    ParameterLabels:
      IamPrefix:
        default: IAM Prefix
      ResourceSuffix:
        default: Resource Suffix
      IngestBucketMappingId:
        default: (Conditional) Mapping ID
      IngestBucketDestinationBucket:
        default: (Conditional) Destination Bucket Name
      IngestBucketDataOwner:
        default: Data Owner
      IngestBucketDataSteward:
        default: Data Steward
      IngestBucketGovPoc:
        default: GOV POC
      IngestBucketKeyOwner:
        default: Key Owner
      AllowedExternalRoleArn:
        default: Allowed Role ARN from Customer Account
      SftpUserName:
        default: SFTP User Name
      SshPublicKeys:
        default: SSH Public Keys
      ObjectExpirationInDays:
        default: Object Expiration In Days

Parameters:
  IamPrefix:
    Type: String
    Description: Required prefix for IAM resources
    Default: AFC2S
    AllowedValues: [AFC2S]
    ConstraintDescription: Must be "AFC2S"

  ResourceSuffix:
    Type: String
    Description: >-
      (Required) Suffix added to the named AWS resources. It must start with a lowercase letter and contain
      only lowercase letters, numbers, and hyphens; its length cannot exceed 20.
    AllowedPattern: ^[a-z0-9-]{1,20}$
    ConstraintDescription: Must start with a lowercase letter and contain only lowercase letters, numbers, and hyphens; its length cannot exceed 20.

  IngestBucketMappingId:
    Type: String
    Description: (Conditional) Value for tag key MappingId. Do not specify a value here if you specify a value in Destination Bucket Name.
    Default: 12346789-abcd-1234-abcd-123456789012
    AllowedPattern: ^$|^[a-f0-9]{8}-([a-f0-9]{4}-){3}[a-f0-9]{12}$
    ConstraintDescription: Must be a valid Mapping ID

  IngestBucketDestinationBucket:
    Type: String
    Description: (Conditional) Value for tag key DestinationBucket. Do not specify a value here if you specify a value in Mapping ID.
    AllowedPattern: ^$|^(?!\s*arn:)\S+$
    ConstraintDescription: Must be a valid bucket name

  IngestBucketDataOwner:
    Type: String
    Description: (Required) Value for tag key DataOwner
    AllowedPattern: (?!.*/).+
    ConstraintDescription: Must have at least one valid character and not contain a slash (/)

  IngestBucketDataSteward:
    Type: String
    Description: (Required) Value for tag key DataSteward
    AllowedPattern: (?!.*/).+
    ConstraintDescription: Must have at least one valid character and not contain a slash (/)

  IngestBucketGovPoc:
    Type: String
    Description: (Required) Value for tag key GovPOC
    AllowedPattern: (?!.*/).+
    ConstraintDescription: Must have at least one valid character and not contain a slash (/)

  IngestBucketKeyOwner:
    Type: String
    Description: (Required) Value for tag key KeyOwner
    AllowedPattern: (?!.*/).+
    ConstraintDescription: Must have at least one valid character and not contain a slash (/)

  AllowedExternalRoleArn:
    Type: String
    Description: (Optional) ARN of the role that is allowed to put objects into the ingestion bucket
    AllowedPattern: ^$|^arn:(aws|aws-us-gov):iam::\d{12}:role/\S+
    ConstraintDescription: Must start with 'arn:' and be composed of lowercase letters, numbers, and hyphens; it cannot exceed 1024 characters.

  SftpUserName:
    Type: String
    Description: Username for SFTP user who is allowed to write to the ingestion bucket via SFTP
    AllowedPattern: ^$|^(?![-.@].*)[a-zA-Z0-9-_.@]{3,100}$
    ConstraintDescription: >-
      Username must be a minimum of 3 and a maximum of 100 characters long.
      The following are valid characters: a-z, A-Z, 0-9, underscore '_', hyphen '-', period '.', and at sign '@'.
      The user name can't start with a hyphen, period, or at sign.

  SshPublicKeys:
    Type: CommaDelimitedList
    Description: >-
      Public key portion of the SSH keys stored for the SFTP user. If adding more than one, separate them with a comma.
      If you want to delete the key(s), clear out the contents from this field.

  ObjectExpirationInDays:
    Type: Number
    Description: Enter the number of days you want to keep objects in the Ingestion Bucket.
    Default: 30

Rules:
  MappingIdOnly:
    RuleCondition: !Not [!Equals [!Ref IngestBucketMappingId, ""]]
    Assertions:
      - Assert: !Equals [!Ref IngestBucketDestinationBucket, ""]
        AssertDescription: You cannot specify a value in both Mapping ID and Destination Bucket Name
  DestinationBucketOnly:
    RuleCondition: !Not [!Equals [!Ref IngestBucketDestinationBucket, ""]]
    Assertions:
      - Assert: !Equals [!Ref IngestBucketMappingId, ""]
        AssertDescription: You cannot specify a value in both Mapping ID and Destination Bucket Name

Conditions:
  CreateSftpUser: !Not [!Equals [!Ref SftpUserName, ""]]
  SshPublicKeyProvided: !Not [!Equals [!Join ["", !Ref SshPublicKeys], ""]]
  UseMappingId: !Not [!Equals [!Ref IngestBucketMappingId, ""]]
  UseDestinationBucket: !Not [!Equals [!Ref IngestBucketDestinationBucket, ""]]
  UseAllowedExternalRoleArn: !Not [!Equals [!Ref AllowedExternalRoleArn, ""]]

Resources:
  IngestBucket:
    Type: AWS::S3::Bucket
    Properties:
      LoggingConfiguration:
        DestinationBucketName:
          Fn::ImportValue: !Sub access-logs-bucket-${ResourceSuffix}
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
              KMSMasterKeyID: !Ref SSES3KmsKey
            BucketKeyEnabled: true
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      NotificationConfiguration:
        LambdaConfigurations:
          - Event: s3:ObjectCreated:*
            Function:
              Fn::ImportValue: !Sub aftac-pipeline-object-tagger-${ResourceSuffix}
      LifecycleConfiguration:
        Rules:
          - Id: ExpireObjectsLifecycleRule
            Status: Enabled
            ExpirationInDays: !Ref ObjectExpirationInDays
            NoncurrentVersionExpiration:
              NoncurrentDays: 1
          - Id: ExpiredObjectDeleteMarkerLifecycleRule
            Status: Enabled
            ExpiredObjectDeleteMarker: true
      Tags:
        - !If
          - UseMappingId
          - Key: MappingId
            Value: !Ref IngestBucketMappingId
          - !Ref AWS::NoValue
        - !If
          - UseDestinationBucket
          - Key: IngestBucketDestinationBucket
            Value: !Ref IngestBucketDestinationBucket
          - !Ref AWS::NoValue
        - Key: DataOwner
          Value: !Ref IngestBucketDataOwner
        - Key: DataSteward
          Value: !Ref IngestBucketDataSteward
        - Key: GovPOC
          Value: !Ref IngestBucketGovPoc
        - Key: KeyOwner
          Value: !Ref IngestBucketKeyOwner

  IngestBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref IngestBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: Restrict to TLS requests only
            Effect: Deny
            Principal:
              AWS: "*"
            Action: s3:*
            Resource:
              - !Sub ${IngestBucket.Arn}
              - !Sub ${IngestBucket.Arn}/*
            Condition:
              Bool:
                aws:SecureTransport: false
          - Sid: Deny a presigned URL request if the signature is more than 5 minutes old
            Effect: Deny
            Principal:
              AWS: "*"
            Action: s3:*
            Resource: !Sub ${IngestBucket.Arn}/*
            Condition:
              NumericGreaterThan:
                s3:signatureAge: 300000 # in milliseconds
          - !If
            - UseAllowedExternalRoleArn
            - Sid: Allow customer role to put objects
              Effect: Allow
              Principal:
                AWS: !Ref AllowedExternalRoleArn
              Action: s3:PutObject
              Resource: !Sub ${IngestBucket.Arn}/*
            - !Ref AWS::NoValue

  SSES3KmsKey:
    Type: AWS::KMS::Key
    DeletionPolicy: Delete
    UpdateReplacePolicy: Delete
    Properties:
      Description: KMS key for an ingestion bucket
      Enabled: true
      EnableKeyRotation: true
      PendingWindowInDays: 30
      KeyPolicy:
        Version: 2012-10-17
        Id: kms-key-policy
        Statement:
          - Sid: Allow administration of the key via IAM policies
            Effect: Allow
            Principal:
              AWS: !Ref AWS::AccountId
            # Allow all but cryptographic operations via IAM policies
            NotAction:
              - kms:Encrypt
              - kms:Decrypt
              - kms:ReEncrypt*
              - kms:GenerateDataKey*
              - kms:CreateGrant
            Resource: "*"
          - Sid: Allow presigned URL generator role to encrypt
            Effect: Allow
            Principal:
              AWS: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${IamPrefix}-PresignedUrlGeneratorRole-${ResourceSuffix}
            Action: kms:GenerateDataKey
            Resource: "*"
            Condition:
              StringEquals:
                kms:ViaService: !Sub s3.${AWS::Region}.amazonaws.com
          - Sid: Allow EC2 Scanner role to decrypt
            Effect: Allow
            Principal:
              AWS: !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:role/${IamPrefix}-Ec2ScannerRole-${ResourceSuffix}
            Action: kms:Decrypt
            Resource: "*"
            Condition:
              StringEquals:
                kms:ViaService: !Sub s3.${AWS::Region}.amazonaws.com
          - !If
            - UseAllowedExternalRoleArn
            - Sid: Allow customer role to encrypt
              Effect: Allow
              Principal:
                AWS: !Ref AllowedExternalRoleArn
              Action: kms:GenerateDataKey
              Resource: "*"
              Condition:
                StringEquals:
                  kms:ViaService: !Sub s3.${AWS::Region}.amazonaws.com
            - !Ref AWS::NoValue
      Tags:
        - Key: CreatedByCloudFormationStack
          Value: !Ref AWS::StackName

  TransferUser:
    Type: AWS::Transfer::User
    Condition: CreateSftpUser
    Properties:
      ServerId:
        Fn::ImportValue: !Sub SFTPServerId-${ResourceSuffix}
      Role:
        Fn::ImportValue: !Sub TransferUserRoleArn-${ResourceSuffix}
      UserName: !Ref SftpUserName
      HomeDirectoryType: LOGICAL
      HomeDirectoryMappings:
        - Entry: / # chroot
          Target: !Sub /${IngestBucket}/${SftpUserName} # Limit visibility to this directory (and below) only
          Type: DIRECTORY
      SshPublicKeys: !If
        - SshPublicKeyProvided
        - !Ref SshPublicKeys
        - []

Outputs:
  IngestBucketName:
    Description: Name of the ingestion bucket
    Value: !Ref IngestBucket
  SSES3KmsKeyId:
    Description: ID of the KMS key for the ingestion bucket
    Value: !Ref SSES3KmsKey
  SSES3KmsKeyArn:
    Description: ARN of the KMS key for the ingestion bucket
    Value: !GetAtt SSES3KmsKey.Arn
