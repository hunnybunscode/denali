# If Data Transfer Lambda in Diode Account exists at time of deployment, need to add the Data Transfer Lambda as a parameter, and
#
Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: General Parameters
        Parameters:
          - AftacVpcId
          - LambdaStorageBucket

      - Label:
          default: Ingest Stack Parameters
        Parameters:
          - TemplateURLIngestStack
          - IngestStackBucket1CDSProfile
          - IngestStackBucket2CDSProfile
          - IngestStackObjectTaggerLambdaCodeKey
          - IngestStackApiGwLambdaCodeKey

      - Label:
          default: Pipeline Stack Parameters
        Parameters:
          - TemplateURLPipelineStack
          - PipelineStackVpcCidr
          - PipelineStackPrivateSubnetIds
          - PipelineStackDiodeAccountId
          - PipelineStackPipelineAmiId
          - ApprovedFileTypes
          - DfdlApprovedFileTypes
          - PipelineStackBucketOneGovPoc
          - PipelineStackBucketOneDataOwner
          - PipelineStackBucketOneKeyOwner
          - PipelineStackBucketTwoGovPoc
          - PipelineStackBucketTwoDataOwner
          - PipelineStackBucketTwoKeyOwner
          - PipelineStackTransferResultLambdaCodeKey
          # - PipelineStackLambdaMappingRoleArn
          # - PipelineStackInvokeTaggerRoleARN
          - PipelineStackDiodeSimulatorInstanceRole

      - Label:
          default: Logging Stack Parameters
        Parameters:
          - TemplateURLLoggingStack
          # - LoggingStackCloudTrailLogsRoleARN

      - Label:
          default: STFP Stack Parameters
        Parameters:
          - TemplateURLSftpServerStack
          - SftpServerStackSftpUserName
          - SftpServerStackSftpServerSubnetIds
          - SftpServerStackSftpBucketDataOwner
          - SftpServerStackSftpBucketGovPoc
          - SftpServerStackSftpBucketKeyOwner

    ParameterLabels:
      IngestStackBucket1CDSProfile:
        default: Ingest Stack Bucket 1 CDS Profile
      IngestStackBucket2CDSProfile:
        default: Ingest Stack Bucket 2 CDS Profile
      PipelineStackDiodeAccountId:
        default: Pipeline Stack Diode Account ID
      TemplateURLIngestStack:
        default: Ingest Stack Template URL
      TemplateURLPipelineStack:
        default: Pipeline Stack Template URL
      TemplateURLLoggingStack:
        default: Logging Stack Template URL
      TemplateURLSftpServerStack:
        default: SFTP Server Stack Template URL
      SftpServerStackSftpUserName:
        default: SFTP Server Stack SFTP User Name
      SftpServerStackSftpServerSubnetIds:
        default: SFTP Server Stack SFTP Server Subnet IDs
      SftpServerStackSftpBucketDataOwner:
        default: SFTP Server Stack SFTP Bucket Data Owner
      SftpServerStackSftpBucketGovPoc:
        default: SFTP Server Stack SFTP Bucket Gov POC
      SftpServerStackSftpBucketKeyOwner:
        default: SFTP Server Stack SFTP Bucket Key Owner
      AftacVpcId:
        default: AFTAC VPC ID
      PipelineStackVpcCidr:
        default: Pipeline Stack VPC CIDR
      PipelineStackPrivateSubnetIds:
        default: Pipeline Stack Private Subnet IDs
      IngestStackObjectTaggerLambdaCodeKey:
        default: Ingest Stack Object Tagger Lambda Code Key
      IngestStackApiGwLambdaCodeKey:
        default: Ingest Stack API Gateway Lambda Code Key
      PipelineStackBucketOneGovPoc:
        default: Pipeline Stack Bucket One Gov POC
      PipelineStackBucketOneDataOwner:
        default: Pipeline Stack Bucket One Data Owner
      PipelineStackBucketOneKeyOwner:
        default: Pipeline Stack Bucket One Key Owner
      PipelineStackBucketTwoGovPoc:
        default: Pipeline Stack Bucket Two Gov POC
      PipelineStackBucketTwoDataOwner:
        default: Pipeline Stack Bucket Two Data Owner
      PipelineStackBucketTwoKeyOwner:
        default: Pipeline Stack Bucket Two Key Owner
      PipelineStackTransferResultLambdaCodeKey:
        default: Pipeline Stack Transfer Result Lambda Code Key
      # PipelineStackLambdaMappingRoleArn:
      #   default: Pipeline Stack Lambda Mapping Role ARN
      PipelineStackDiodeSimulatorInstanceRole:
        default: Pipeline Stack Diode Simulator Instance Role
      # PipelineStackInvokeTaggerRoleARN:
      #   default: Pipeline Stack Invoke Tagger Role ARN
      LambdaStorageBucket:
        default: Lambda Storage Bucket
      # LoggingStackCloudTrailLogsRoleARN:
      #   default: Logging Stack CloudTrail Logs Role ARN
      PipelineStackPipelineAmiId:
        default: Pipeline Stack Pipeline AMI ID
      ApprovedFileTypes:
        default: Approved File Types
      DfdlApprovedFileTypes:
        default: DFDL Approved File Types

Parameters:
  IngestStackBucket1CDSProfile:
    Type: String
    Description: CDS Profile for IngestBucket1
    AllowedValues: [CDS_1, CDS_2, CDS_3]

  IngestStackBucket2CDSProfile:
    Type: String
    Description: CDS Profile for IngestBucket2
    AllowedValues: [CDS_1, CDS_2, CDS_3]

  PipelineStackDiodeAccountId:
    Type: String
    Description: Account ID for Diode Account
    Default: 062339239041

  TemplateURLSftpServerStack:
    Type: String
    Description: S3 URL for SftpServerStack

  TemplateURLLoggingStack:
    Type: String
    Description: S3 URL for LoggingStack
    Default: https://aftac-cloudformation-templates.s3.us-gov-west-1.amazonaws.com/aftac_logging_stack.yaml

  TemplateURLIngestStack:
    Type: String
    Description: S3 URL for IngestStack
    Default: https://aftac-cloudformation-templates.s3.us-gov-west-1.amazonaws.com/aftac_ingest_stack.yaml

  TemplateURLPipelineStack:
    Type: String
    Description: S3 URL for PipelineStack
    Default: https://aftac-cloudformation-templates.s3.us-gov-west-1.amazonaws.com/aftac_pipeline_stack.yaml

  SftpServerStackSftpUserName:
    Type: String
    Description: Username for SFTP user
    Default: sftpuser

  AftacVpcId:
    Type: String
    Description: VPC ID for AFTAC Cloud
    Default: vpc-0e8995e670cc55aed

  SftpServerStackSftpServerSubnetIds:
    Type: CommaDelimitedList
    Description: Comma Separated List of Two (2) Subnet IDs for SFTP server
    Default: subnet-047423901be4b2a74, subnet-0e7af08e515c92771

  # LoggingStackCloudTrailLogsRoleARN:
  #   Type: String
  #   Description: ARN of the role that CloudTrail will assume to put logs into the log bucket.
  #   Default: arn:aws-us-gov:iam::073653673774:role/my-iam-stack-TrailLogsRole-rBO5JjPMv9i2

  LambdaStorageBucket:
    Type: String
    Description: S3 bucket where the lambda code is stored
    Default: aftac-cloudformation-templates

  IngestStackObjectTaggerLambdaCodeKey:
    Type: String
    Description: S3 key for the ObjectTagger lambda code
    Default: lambda_functions/object_tagger.zip

  IngestStackApiGwLambdaCodeKey:
    Type: String
    Description: S3 key for the API Gateway lambda code
    Default: lambda_functions/presigner.zip

  PipelineStackPipelineAmiId:
    Type: String
    Description: The AMI ID to use for the pipeline.
    Default: ami-06e637594d4f5ea44

  PipelineStackBucketOneGovPoc:
    Type: String
    Description: String to be added as a tag to objects in Bucket 1
    Default: Monica

  PipelineStackBucketOneDataOwner:
    Type: String
    Description: String to be added as a tag to objects in Bucket 1
    Default: Phoebe

  PipelineStackBucketOneKeyOwner:
    Type: String
    Description: String to be added as a tag to objects in Bucket 1
    Default: Chandler

  PipelineStackBucketTwoGovPoc:
    Type: String
    Description: String to be added as a tag to objects in Bucket 2
    Default: Ross

  PipelineStackBucketTwoDataOwner:
    Type: String
    Description: String to be added as a tag to objects in Bucket 2
    Default: Rachel

  PipelineStackBucketTwoKeyOwner:
    Type: String
    Description: String to be added as a tag to objects in Bucket 2
    Default: Joey

  PipelineStackVpcCidr:
    Type: String
    Description: The CIDR block of the existing VPC
    Default: 10.161.64.0/20

  PipelineStackPrivateSubnetIds:
    Type: CommaDelimitedList
    Description: The list of private subnet IDs to use for the pipeline
    Default: subnet-0da24508eee08b8ef, subnet-06ec78f23d6fbb8a6, subnet-024def395a2dd8eda

  PipelineStackTransferResultLambdaCodeKey:
    Type: String
    Description: The S3 key of the pipeline lambda code
    Default: lambda_functions/transfer_result.zip

  # PipelineStackLambdaMappingRoleArn:
  #   Type: String
  #   Description: The ARN of the Lambda Mapping Role

  # PipelineStackInvokeTaggerRoleARN:
  #   Type: String
  #   Description: The ARN of the Invoke Tagger Role
  #   Default: arn:aws-us-gov:iam::073653673774:role/my-iam-stack-InvokeTaggerRole-PAzxCua6YczE

  PipelineStackDiodeSimulatorInstanceRole:
    Type: String
    Description: >
      If using a Diode Simulator, the ARN of the role associated with the instance profile for the Diode Simulator instance.
      Otherwise, leave it blank.
    AllowedPattern: ^$|^arn:(aws|aws-us-gov):iam::\d{12}:role/.*

  SftpServerStackSftpBucketDataOwner:
    Type: String
    Description: Name of the Sftp Server Data Owner
    Default: George

  SftpServerStackSftpBucketGovPoc:
    Type: String
    Description: Name of the Sftp Server Gov Poc
    Default: Jerry

  SftpServerStackSftpBucketKeyOwner:
    Type: String
    Description: Name of the Sftp Server Key Owner
    Default: Cosmo

  # CustomResourceCodeKey:
  #   Type: String
  #   Description: The S3 key of the custom resource code
  #   Default: lambda_functions/CustomResourceCode.zip

  # AddEventNotificationCodeKey:
  #   Type: String
  #   Description: The S3 key of the add event notification code
  #   Default: lambda_functions/AddEventNotificationCode.zip

  ApprovedFileTypes:
    Type: String
    Description: A Comma Separated List of File Types to be Allowed through the validation pipeline
    Default: csv, flac, wav, mp4, txt, json, zip

  DfdlApprovedFileTypes:
    Type: String
    Description: A Comma Separated List of File Types to be Allowed through the DFDL validation pipeline
    Default: infoset, xml

Resources:
  SftpServerStack:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      TemplateURL: !Ref TemplateURLSftpServerStack
      Parameters:
        SftpUserName: !Ref SftpServerStackSftpUserName
        TransferUserRoleArn: !ImportValue TransferUserRoleArn
        TransferLoggingRoleArn: !ImportValue TransferLoggingRoleArn
        AftacVpcId: !Ref AftacVpcId
        SftpServerSubnetIds:
          !Join [",", !Ref SftpServerStackSftpServerSubnetIds]
        SftpBucketDataOwner: !Ref SftpServerStackSftpBucketDataOwner
        SftpBucketGovPoc: !Ref SftpServerStackSftpBucketGovPoc
        SftpBucketKeyOwner: !Ref SftpServerStackSftpBucketKeyOwner
        LambdaStorageBucket: !Ref LambdaStorageBucket
        ObjectTaggerRoleARN: !ImportValue ObjectTaggerRoleArn
        PrivateSubnetIds: !Join [",", !Ref PipelineStackPrivateSubnetIds]
        ObjectTaggerLambdaCodeKey: !Ref IngestStackObjectTaggerLambdaCodeKey
        # TransferResultLambdaCodeKey: !Ref PipelineStackTransferResultLambdaCodeKey
    DependsOn: PipelineStack

  LoggingStack:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      TemplateURL: !Ref TemplateURLLoggingStack

  IngestStack:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      TemplateURL: !Ref TemplateURLIngestStack
      Parameters:
        ObjectTaggerRoleARN: !ImportValue ObjectTaggerRoleArn
        presigngeneratorServiceRole: !ImportValue PresignGeneratorServiceRoleArn
        LambdaStorageBucket: !Ref LambdaStorageBucket
        ApiGwLambdaCodeKey: !Ref IngestStackApiGwLambdaCodeKey
        fileuploaderCloudWatchRole: !ImportValue FileUploaderCloudWatchRoleArn
        APILambdaInvokeRole: !ImportValue APILambdaInvokeRoleArn
        AftacVpcId: !Ref AftacVpcId
        PrivateSubnetIds: !Join [",", !Ref PipelineStackPrivateSubnetIds]
        BucketOneGovPoc: !Ref PipelineStackBucketOneGovPoc
        BucketOneDataOwner: !Ref PipelineStackBucketOneDataOwner
        BucketOneKeyOwner: !Ref PipelineStackBucketOneKeyOwner
        BucketTwoGovPoc: !Ref PipelineStackBucketTwoGovPoc
        BucketTwoDataOwner: !Ref PipelineStackBucketTwoDataOwner
        BucketTwoKeyOwner: !Ref PipelineStackBucketTwoKeyOwner
        ObjectTaggerLambdaCodeKey: !Ref IngestStackObjectTaggerLambdaCodeKey
        Bucket1CDSProfile: !Ref IngestStackBucket1CDSProfile
        Bucket2CDSProfile: !Ref IngestStackBucket2CDSProfile
    DependsOn:
      - LoggingStack

  PipelineStack:
    Type: AWS::CloudFormation::Stack
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      TemplateURL: !Ref TemplateURLPipelineStack
      Parameters:
        # LambdaMappingRoleArn: !Ref PipelineStackLambdaMappingRoleArn
        DiodeAccountId: !Ref PipelineStackDiodeAccountId
        PipelineAmiId: !Ref PipelineStackPipelineAmiId
        VpcCidr: !Ref PipelineStackVpcCidr
        Ec2ScannerInstanceProfileARN: !ImportValue Ec2ScannerInstanceProfile
        PrivateSubnetIds: !Join [",", !Ref PipelineStackPrivateSubnetIds]
        AftacVpcId: !Ref AftacVpcId
        TransferResultLambdaCodeKey: !Ref PipelineStackTransferResultLambdaCodeKey
        TransferResultServiceRole: !ImportValue TransferResultLambdaRoleArn
        LambdaStorageBucket: !Ref LambdaStorageBucket
        ApprovedFileTypes: !Ref ApprovedFileTypes
        DiodeSimulatorInstanceRole: !Ref PipelineStackDiodeSimulatorInstanceRole
        DfdlApprovedFileTypes: !Ref DfdlApprovedFileTypes
    DependsOn:
      - IngestStack
