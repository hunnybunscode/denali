name: AllowOperationalStatus
description: Some hardening causes operational status to fail, this reverses some of the hardening.
schemaVersion: 1.0

phases:
  - name: build
    steps:
      - name: selinux-container
        action: ExecuteBash
        inputs:
          commands:
            - |
              # install jq and container-selinux for EKS amis
              if command -v dnf &> /dev/null && command -v kubelet &> /dev/null; then
                sudo dnf install jq container-selinux -y
                sudo semanage permissive --add kubelet_t
                sudo chcon --type bin_t $(which nodeadm)
              elif command -v kubelet &> /dev/null; then
                sudo amazon-linux-extras enable selinux-ng
                sudo yum install jq container-selinux -y
              fi

      - name: EnableIPv4Forwarding
        action: ExecuteBash
        inputs:
          commands:
            - |
              if [[ ! -d /etc/sysctl.d/ ]]; then
                sudo mkdir /etc/sysctl.d/
              fi
              sudo sh -c 'cat << EOF > /etc/sysctl.d/999-imagebuilder_allowOPstatus.conf
              net.ipv4.ip_forward = 1
              net.ipv4.conf.all.forwarding = 1
              EOF'
              sudo sysctl --system
