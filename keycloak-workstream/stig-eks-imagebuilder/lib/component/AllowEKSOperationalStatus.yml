name: Allow EKS Operational Status
description: Some hardening causes operational status to fail, this reverses some of the hardening for EKS
schemaVersion: 1.0

phases:
  - name: build
    steps:
      - name: selinux-container
        action: ExecuteBash
        inputs:
          commands:
            - |
              # install jq and container-selinux for EKS AMIs
              if command -v dnf &> /dev/null && command -v kubelet &> /dev/null; then
                sudo dnf install jq container-selinux -y
                sudo semanage permissive --add kubelet_t
                sudo chcon --type bin_t $(which nodeadm)
              elif command -v kubelet &> /dev/null; then
                sudo amazon-linux-extras enable selinux-ng
                sudo yum install jq container-selinux -y
              fi

      - name: EnableIPv4Forwarding
        action: ExecuteBash
        inputs:
          commands:
            - |
              if [[ ! -d /etc/sysctl.d/ ]]; then
                sudo mkdir /etc/sysctl.d/
              fi
              sudo sh -c 'cat << EOF > /etc/sysctl.d/999-imagebuilder_allowOPstatus.conf
              net.ipv4.ip_forward = 1
              net.ipv4.conf.all.forwarding = 1
              EOF'
              sudo sysctl --system

      - name: RHEL-fapolicyd-rule-config
        action: ExecuteBash
        inputs:
          commands:
            - |
              RULES=/etc/fapolicyd/rules.d/70-allow_op_status.rules

              if [[ -f $RULES ]]; then
                sudo rm $RULES
              fi

              # Create the rules file with proper permissions
              sudo tee "$RULES" << 'EOF' > /dev/null
              allow perm=execute exe=/usr/bin/containerd-shim-runc-v2 : all
              allow perm=execute exe=/usr/bin/containerd : all
              allow perm=execute exe=/usr/bin/kubelet : all
              allow perm=open exe=/usr/bin/containerd-shim-runc-v2 : all 
              allow perm=open exe=/usr/bin/containerd : all
              allow perm=open exe=/usr/bin/kubelet : all
              EOF

              echo "Load fapolicyd rules..."
              sudo fagenrules --load

              echo "Restarting fapolicyd after adding rules..."
              sudo systemctl restart fapolicyd

              # Allow some time for the service to restart if needed
              sleep 2

              # Verify the rules are loaded
              sudo fapolicyd-cli --list
      - name: Check-Journal-Folder
        action: ExecuteBash
        inputs:
          commands:
            - |
              if [[ ! -d /var/log/journal ]]; then
                sudo ln -s /run/log/journal /var/log/journal
              fi

  - name: validate
    steps:
      - name: Validate-EKS-Software
        action: ExecuteBash
        inputs:
          commands:
            - |
              nodeadm --version
