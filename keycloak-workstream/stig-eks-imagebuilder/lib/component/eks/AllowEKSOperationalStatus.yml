name: AllowEKSOperationalStatus
description: Some hardening causes operational status to fail, this reverses some of the hardening.
schemaVersion: 1.0

phases:
  - name: build
    steps:
      - name: selinux-container
        action: ExecuteBash
        inputs:
          commands:
            - |
              # Install jq and container-selinux for EKS AMIs
              if command -v dnf &> /dev/null && command -v kubelet &> /dev/null; then
                sudo dnf install jq container-selinux -y
                sudo semanage permissive --add kubelet_t
                sudo chcon --type bin_t $(which nodeadm)
              elif command -v kubelet &> /dev/null; then
                sudo amazon-linux-extras enable selinux-ng
                sudo yum install jq container-selinux -y
              fi

      - name: EnableIPv4Forwarding
        action: ExecuteBash
        inputs:
          commands:
            - |
              if [[ ! -d /etc/sysctl.d/ ]]; then
                sudo mkdir /etc/sysctl.d/
              fi
              sudo sh -c 'cat << EOF > /etc/sysctl.d/999-imagebuilder_allowOPstatus.conf
              net.ipv4.ip_forward = 1
              net.ipv4.conf.all.forwarding = 1
              EOF
              '
              sudo sysctl --system

      - name: fapolicyd-rule-config
        action: ExecuteBash
        onFailure: Ignore
        maxAttempts: 1
        inputs:
          commands:
            - |
              if command -v fapolicyd-cli > /dev/null; then
                RULES="/etc/fapolicyd/rules.d/00-allow_op_status.rules"

                if [[ -f "$RULES" ]]; then
                  sudo rm "$RULES"
                fi

                echo "Creating fapolicyd rules..."

                sudo tee "$RULES" > /dev/null << 'EOF'
              allow perm=execute exe=/usr/bin/ctr : all
              allow perm=execute exe=/usr/bin/containerd : all
              allow perm=execute exe=/usr/bin/containerd-stress : all
              allow perm=execute exe=/usr/bin/containerd-shim-runc-v2 : all
              allow perm=execute exe=/usr/bin/kubelet : all

              allow perm=open all : dir=/usr/lib64/
              allow perm=any all : dir=/opt/cni/
              allow perm=any all : dir=/var/lib/kubelet/
              EOF

                echo "Loading fapolicyd rules..."
                sudo fagenrules --load

                echo "Updating fapolicyd service configuration..."
                sudo sed -i 's|^ExecStart=.*|ExecStart=/usr/sbin/fapolicyd --debug-deny|' /usr/lib/systemd/system/fapolicyd.service

                fapolicyd-cli --check-config

                echo "Restarting fapolicyd..."
                sudo systemctl daemon-reload
                sudo systemctl restart fapolicyd

                sleep 2

                echo "Verifying rules..."
                sudo fapolicyd-cli --list
              else
                echo "fapolicyd-cli not found. Skipping rule configuration."
              fi

  - name: validate
    steps:
      - name: Validate-EKS-Software
        action: ExecuteBash
        inputs:
          commands:
            - |
              nodeadm --version
